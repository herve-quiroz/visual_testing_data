# Claude Instructions

## About This Document

**Scope:** These are universal guidelines that apply to all Claude AI work on this repository, regardless of which mode of operation is being used (Claude Desktop, autonomous Claude Code, or interactive Claude Code).

---

* Use `Claude Code` as the Git user name and `herve.quiroz+claude@gmail.com` as the user email address.
* Do not add a "Co-Authored-By:" entry in the commit messages.

## Commit Configuration

**IMPORTANT**: Always use these exact values for commits:
* Author Name: Claude Code
* Author Email: `herve.quiroz+claude@gmail.com`

‚ö†Ô∏è **Common Mistake**: Do NOT add `Co-Authored-By: Claude <noreply@anthropic.com>` in the commit message

## Pre-Commit Checklist

Before making any commits, verify:
- [ ] Author email is `herve.quiroz+claude@gmail.com`
- [ ] Branch name follows `claude/description` pattern
- [ ] Commit message is descriptive
- [ ] Commit message formatting is correct (no literal `\n` characters, proper line breaks)
- [ ] All tests pass if applicable

## Commit Message Validation

When creating commit messages through the GitHub API, ensure:
- [ ] Use actual newline characters, not escaped `\n` sequences
- [ ] Multi-line messages have proper formatting
- [ ] No visible `\n` characters appear in the final commit message
- [ ] Message follows repository commit conventions
- [ ] Do NOT add a `Co-Authored-By:` entry in the commit message

**Example of correct multi-line commit message formatting:**
```
Add feature X to improve Y

- Add new functionality for better user experience
- Include proper error handling and validation
- Update tests to cover new scenarios

This change addresses the requirements outlined in issue #123
and improves the overall reliability of the system.
```

## Branches

* Branch naming: `claude/description`
* When working on branch to address an issue: `claude/fix-<issue_number>` or `claude/issue-<issue_number>`

## Pull requests

* Pull requests should only be sent for review after all tests pass and quality checks succeed.
* When checking for errors or warnings from Github actions, look into warnings that don't necessarily cause the action to fail.
* Do not merge pull requests yourself. Pull requests should be approved by the owner of the repository.
* Pull requests created by Claude should have the `claude` label.
* Pull requests created to address a given issue should contain `fixes #123` (with the right issue number) in their descriptions so that merging the pull request automatically closes the issue. See [Linking a pull request to an issue](https://docs.github.com/en/issues/tracking-your-work-with-issues/using-issues/linking-a-pull-request-to-an-issue) for details.

### PR Description Template

When creating a PR, include:
- Summary of changes
- Testing approach
- Related issues (use `fixes #123` format)

## Handling Review Comments

‚ö†Ô∏è **CRITICAL**: You MUST reply to each review comment appropriately

### For each review comment:
1. Make the requested code change
2. Post a clear response explaining what was done
3. Reference specific commit SHAs where changes were made

### Finding and Replying to Review Comments

**To find all review comments with details:**
```bash
# List all review comments with IDs and content
gh api repos/{owner}/{repo}/pulls/{pr_number}/comments --paginate | jq -r '.[] | "\(.id) | \(.path):\(.line) | \(.body)"'
```

**GitHub CLI Methods for Responding:**

1. **For summarizing addressed changes (preferred method):**
```bash
gh pr review {pr_number} --comment --body "Addressed review comments:
- Fixed X by doing Y (addresses comment {id})
- Changed A to B (addresses comment {id})

---
‚ú® Content generated by Claude AI."
```

2. **For individual comment responses:**
```bash
gh pr comment {pr_number} --body "Addressed review comment {id} about X:
- Changed Y to Z in commit {sha}
- Updated tests to reflect new behavior

---
‚ú® Content generated by Claude AI."
```

**Best Practice:**
- Reference specific comment IDs in your responses
- Quote relevant parts of the original comment
- Explain exactly what was changed and in which commit
- Group related comments in a single comprehensive response
- **ALWAYS include the Claude footer** (see "Comments" section) - this is required for all responses

### Updating PR Description After Approach Changes

When review feedback leads to a **change in the overall approach or strategy** of a PR (not just minor code fixes), the PR description **MUST** be updated to reflect the current state:

1. Update the Summary/Changes sections to describe the **actual** approach taken
2. Use `gh pr edit {pr_number} --body "..."` to update the description
3. Optionally keep the original approach in a collapsed section for context:

```markdown
<details>
<summary>Original approach (superseded)</summary>
[Original description here]
</details>
```

**Why this matters:** The PR description is the primary documentation of what a PR does. Reviewers and future readers rely on it. A stale description that describes a superseded approach is misleading.

### Marking Comments as Resolved

Review threads can be resolved using the GitHub GraphQL API via `gh api graphql`:

**To get review thread IDs:**
```bash
gh api graphql -f query='
query {
  repository(owner: "{owner}", name: "{repo}") {
    pullRequest(number: {pr_number}) {
      reviewThreads(first: 50) {
        nodes {
          id
          isResolved
          comments(first: 1) {
            nodes { body }
          }
        }
      }
    }
  }
}'
```

**To resolve a review thread:**
```bash
gh api graphql -f query='
mutation {
  resolveReviewThread(input: {threadId: "THREAD_ID"}) {
    thread { id isResolved }
  }
}'
```

**Best Practice:**
1. After addressing a review comment, resolve the thread using the GraphQL mutation
2. Post a response explaining what was done and reference the commit SHA
3. This keeps the PR conversation clean by hiding resolved discussions

## Resolving Merge Conflicts

When a PR has both the `claude` and `merge-conflict` labels, conflicts must be resolved before the PR can be merged.

### Conflict Resolution Process

1. **Fetch the latest changes:**
   ```bash
   git checkout main
   git pull origin main
   git checkout <branch-name>
   ```

2. **Attempt merge:**
   ```bash
   git merge main
   ```

3. **If conflicts occur:**
   - Read conflicted files to understand both changes
   - Resolve conflicts by combining changes appropriately
   - Preserve the intent of both the base branch and your changes
   - **ALWAYS require explicit review and resolution** - do not attempt automatic resolution
   - If conflicts are too complex, add `input required` label and ask for human help

4. **Commit and push:**
   ```bash
   git add <resolved-files>
   git commit -m "Resolve merge conflicts with main

   Merged latest changes from main branch and resolved conflicts in:
   - <file1>
   - <file2>

   ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

   Co-Authored-By: Claude <noreply@anthropic.com>"
   git push
   ```

5. **Verify:** The `merge-conflict` label should be automatically removed once conflicts are resolved

### Important Guidelines

- Carefully review both sides of each conflict
- Don't blindly accept "ours" or "theirs"
- Ensure the merged code maintains consistency
- Run tests after resolving conflicts
- For complex conflicts, add `input required` label and ask for help

## Branch Management

* ALWAYS create a new branch for each task/issue
* NEVER reuse branches that have already been merged
* Branch naming convention: `claude/issue-{issue-number}` or `claude/{descriptive-name}`
* Before starting work, check out main and create a fresh branch from it

## When working on a Github issue

* Create a pull request with the branch naming convention above
* Add the `claude` label to the pull request
* Describe your approach in the pull request description
* Make sure all tests pass and then mark the pull request as ready for review

## Comments (Github issues and pull requests)

‚ö†Ô∏è **CRITICAL**: ALL Claude-generated content on GitHub MUST include the footer below. This includes:
- PR descriptions
- Issue comments
- PR comments
- Review responses
- Any other text posted to GitHub

Add the following footer to identify Claude-generated content easily:

```
---
‚ú® Content generated by Claude AI.
```

## Planning without timelines

When planning tasks, provide concrete implementation steps without time estimates. Never suggest timelines like "this will take 2-3 weeks" or "we can do this later." Focus on what needs to be done, not when. Break work into actionable steps and let users decide scheduling.

**Examples:**

‚ùå **Don't:**
- "This will take approximately 2-3 days of focused work"
- "Implementation estimate: ~1 week"
- "We can tackle this in the next sprint"

‚úÖ **Do:**
- "This requires changes to: configuration handling, work detection logic, and workspace management"
- "Implementation involves: parsing new environment variable, updating repository selection logic, and adding tests"
- Focus on technical scope and complexity, not duration

## Track issues and blockers

* When blocked in your development because you're missing some capability (e.g. MCP server or access to a specific development tool in your environment), create an issue in this Github repository to describe what's missing
* The issue title should contain `[Claude]` as a prefix. e.g. `[Claude] Missing tool: <some_tool>`
* Check beforehand that a similar issue does not exist. If one does exist, consider adding additional context and information based on the current task at hand
* Avoid duplicate content in the Github issue as this will be read by humans. Consider editing existing comments to refine the explanations rather than adding new comments
* Do not apply the `claude` tag to the issue yourself
* Remember to use the same footer as for other discussions to indicate that the issue content or comment was generated by Claude

## Clean-up changes

* When removing logic, don't leave comments about it. If things don't exist, we don't need to mention them

## Label-Based Work Control

### Required Labels for Claude Work
- **`claude`** - Issue is assigned to Claude for implementation
- **NOT `blocked`** - Issue dependencies are satisfied and work can begin

### Blocked Label Usage
The `blocked` label indicates that an issue has unmet dependencies and should not be worked on yet:

- **NEVER work on issues with the `blocked` label**, even if they also have the `claude` label
- Issues become unblocked when their dependencies are completed (dependencies will be listed in the issue description)
- When checking for available work, use: `gh issue list --label claude --label "!blocked"`
- If all `claude` issues are `blocked`, no work should be started - wait for dependencies to be completed

### Dependency Management
- Issues with dependencies will initially have both `claude` and `blocked` labels
- When prerequisite issues are completed, the `blocked` label should be removed from dependent issues
- This ensures proper ordering for complex features with multiple interdependent components

## Creating and managing Github issues

* NEVER add the `claude` label on a Github issue yourself unless it's requested explicitly
* NEVER work on an issue that depends on functionality added by another open issue. Instead, skip it until the other issue is closed

## Special Issue Types

### Design Issues

Issues labeled with `design` are for design discussions and planning, not immediate implementation.

- **`design`** label indicates an issue is about discussing and documenting design decisions
- Design issues focus on planning, architecture, and requirements gathering
- Design work results in documentation updates, commits go directly to main (no PR needed)
- Once design is finalized, implementation issues can be created based on the design decisions

For detailed workflow steps, see the `find-work` skill's `references/design-workflow.md`.

### Discuss Issues

Issues labeled with `discuss` are for lightweight Q&A and clarification within the issue thread itself.

- **`discuss`** label indicates an issue needs clarification before implementation
- Discussion happens entirely within the issue (no code changes, no branches)
- Claude updates the issue description and posts summary comments
- Once `discuss` label is removed, the issue transitions to normal implementation

For detailed workflow steps, see the `find-work` skill's `references/discuss-workflow.md`.

### Documentation Issues (No Label Required)

Some issues request documentation updates rather than code implementation. These can be identified by **signals in the issue title or body**, even without a special label.

**Strong indicators (any one = treat as documentation issue):**

1. **Title starts with:** `Design:` or `Plan:` (case-insensitive)
2. **Body starts with:** `Doc:`, `Docs:`, `Document:`, or `Documents:` (case-insensitive) followed by a file path in backticks

**Supporting indicators (consider in context):**

3. Title contains words like "design", "document", "documentation", "spec", "specification", "plan", "planning"
4. Body references markdown files (`.md`) as the primary subject
5. Issue describes what to capture/record/document rather than what to build/implement

**Behavior for documentation issues:**

- The deliverable is **updating documentation**, not writing code
- Look for the referenced doc file path (e.g., `` Doc: `doc/gameplay.md` ``) to know where changes go
- If no explicit path, infer from context or ask for clarification
- **Create a PR** with documentation changes (do NOT commit directly to main)
- PR title and description should reflect documentation work, not implementation

**When signals are ambiguous:**

If an issue has mixed signals (e.g., title says "Design" but body describes implementation tasks), **post a clarifying comment** on the issue before starting work. Ask whether the expected deliverable is documentation updates or code implementation.

**Examples:**

| Issue Title | Body Starts With | Interpretation |
|-------------|------------------|----------------|
| "Design: equipment system" | `Doc: \`doc/gameplay.md\`` | Documentation issue |
| "Plan: save game format" | `Documents: \`doc/serialization.md\`` | Documentation issue |
| "Add inventory management" | Implementation details | Code implementation |
| "Design: new feature" | Code snippets, no doc reference | Ambiguous - ask for clarification |

### Label Precedence

- **`blocked`** label always takes precedence - never work on blocked issues regardless of other labels
- If an issue has both `discuss` and `design` labels, treat it as a `discuss` issue
- Documentation issues (detected by title/body signals) take precedence over assuming code implementation

## Issue Dependencies

This repository uses GitHub's native issue dependencies feature to track which issues are blocked by other issues. A GitHub Actions workflow automatically manages `blocked` and `ready` labels based on dependency status.

‚ö†Ô∏è **CRITICAL**: Always use GitHub's native issue dependencies API to define dependencies. **NEVER** add dependency information to the issue description (e.g., `## Dependencies` sections, `Depends on: #123`, or `Blocked by: #456` text). The text-based approach is deprecated and will not be recognized by the automation.

When asked to "mark an issue as blocked by" or "add dependencies to an issue", always use the native GitHub API as shown below.

### How to Define Dependencies

Use GitHub's native issue dependencies feature through the GitHub UI or the API:

**Using the GitHub UI:**
1. Open the issue that depends on another issue
2. In the right sidebar, find "Development" section
3. Click "Blocked by" to add issues this one depends on

**Using the GitHub CLI:**
```bash
# Add a dependency (issue 123 is blocked by issue 456)
issue_id=$(gh api repos/{owner}/{repo}/issues/456 --jq '.id')
gh api repos/{owner}/{repo}/issues/123/dependencies/blocked_by \
    -X POST \
    -F "issue_id=$issue_id"

# List blocked-by dependencies
gh api repos/{owner}/{repo}/issues/123/dependencies/blocked_by

# Remove a dependency
gh api repos/{owner}/{repo}/issues/123/dependencies/blocked_by/{issue_id} -X DELETE
```

### Label Management

The workflow automatically manages labels based on native dependency status:

- **`ready`** label - Added when:
  - Issue has no dependencies, OR
  - All dependency issues are closed

- **`blocked`** label - Added when:
  - Issue has one or more open dependency issues

- The workflow removes the opposite label when updating (e.g., removes `blocked` when adding `ready`)

### Dependency Visibility

Native dependencies are displayed in the GitHub UI:
- In the issue sidebar under "Development" ‚Üí "Blocked by"
- In the issue timeline as events
- Dependencies are searchable through GitHub

### When to Work on Issues

**Claude should only work on issues that:**
1. Have the `claude` label
2. Do NOT have the `blocked` label (or have the `ready` label)
3. Have no open dependencies

Once all dependency issues are closed, the workflow will:
1. Remove the `blocked` label
2. Add the `ready` label
3. Make the issue available for Claude to work on

## Repository-Specific Guidelines

This repository contains artefacts for visual testing from various projects.
